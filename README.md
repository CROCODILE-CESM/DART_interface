# DART_interface

**CESM-DART interface for MOM6 in the CROCODILE project**

This repository provides the infrastructure to integrate the Data Assimilation Research Testbed (DART) with the Community Earth System Model (CESM), specifically for the MOM6 ocean component. 


## Repository Overview

The DART_interface includes:

- **CIME integration scripts** (`cime_config/`) - Scripts to run DART assimilation within CESM workflows
- **Parameter template tools** (`param_templates/`) - Utilities for managing DART configuration files
- **Build templates** (`cesm_build_templates/`) - Templates for building DART with CESM
- **NUOPC driver** (`nuopc_driver/`) - NUOPC component interface for DART. This is a dummy interface as DART is not a NUOPC component.
- **Test suite** (`tests/`) - Automated tests for assimilation scripts

### Key Components

#### `cime_config/assimilate.py`
The main data assimilation script that:
- Stages DART input files and observations
- Manages MOM6 restart files for ensemble members
- Runs the DART filter executable
- Handles file backup and restoration to avoid naming conflicts between MOM6 and DART

#### `cime_config/buildnml`
CIME script that generates DART namelists and configuration files during case setup. This script is called automatically by CESM during the `case.setup` and `case.build` phases, and is called by `preview_namelists`.

**Key responsibilities:**
- **Configuration validation** - Verifies calendar is set to GREGORIAN (required by DART)
- **Namelist generation** - Creates `input.nml` from JSON templates with case-specific values:
  - Sets ensemble size (`ens_size`) to match the number of ocean instances (`NINST_OCN`)
  - Merges user customizations from `user_nl_dart` into the template
  - Includes a custom Fortran namelist parser to handle user overrides
- **Variable configuration** - Sets CESM XML variables:
  - `DATA_ASSIMILATION_SCRIPT` - Points to `assimilate.py`
  - `NTASKS_ESP` - Sets number of tasks for DART equal to the number of tasks used for the ocean component.
- **File staging** - Copies sampling error correction table if needed (for ensemble sizes 3-200)
- **Input data list** - Generates list of required observational data files

The script reads from `param_templates/json/input_nml.json` and writes to `Buildconf/dartconf/input.nml`.

#### `cime_config/buildlib`
CIME script that builds the DART executables and creates the DART library during `case.build`.

**Key responsibilities:**
- **Compiler configuration** - Selects appropriate `mkmf.template` based on compiler (Intel or GNU)
- **DART executable building** - Builds three DART programs:
  - `filter` - Main assimilation executable
  - `perfect_model_obs` - Creates synthetic observations from model state
  - `fill_inflation_restart` - Initializes adaptive inflation files
- **Quickbuild automation** - Creates and executes a customized `quickbuild.sh` script:
  - Substitutes absolute paths for DART source directory
  - Creates `preprocess_input.nml` for DART preprocessing step
  - Modifies `mkmf` to use parallel make (`-j 8`) for faster compilation
- **Library creation** - Builds a minimal `libesp.a` library containing the NUOPC driver stub
- **Validation** - Checks that `DATA_ASSIMILATION_CYCLES` is greater than 0

The build process places executables in `$EXEROOT/esp/` where they can be accessed during the assimilation cycle.

#### Parameter Template Tools (`param_templates/`)

**`extract_namelist_defaults.py`**  
Extracts default namelist values from DART Fortran source files using the fparser2 library. This script parses `.f90` files to identify namelist declarations and their default values, outputting them in Fortran namelist format.

**`process_makefile_f90.sh`**  
Bash script that extracts all `.f90` source files listed in the DART Makefile.mom6.filter and calls `extract_namelist_defaults.py` on each file to generate a complete `input.nml` file with default values for all DART modules.


The 'Makefile.mom6.filter' included in this repository was created by running `quickbuild.sh filter` in the MOM6 DART model work directory.

The input.nml generated by `process_makefile_f90.sh` has to be hand edited to have
sensible defaults for DART-MOM6. 

The input.nml with sensible defaults for every user-settable option is so these 
options can be changed with user_nml_dart. 

**`nml_to_yaml.py`**  
Converts Fortran namelist files (`input.nml`) to YAML format (`input_nml.yaml`). Uses the f90nml library to parse namelists and wraps each value in a `{'values': value}` structure for compatibility with CESM parameter management.

**`yaml_to_json.py`**  
Converts YAML parameter files to JSON format for use in CESM. Processes multiple YAML files (`input_nml.yaml`, `DART_params.yaml`, `input_data_list.yaml`) and outputs corresponding JSON files to the `json/` directory.

## Required Repositories

**CESM:** The Community Earth System Model  
https://github.com/hkershaw-brown/CESM.git  
Branch: `dart-cesm3.0-alphabranch`

**CMEPS:** NUOPC based Community Mediator for Earth Prediction Systems  
https://github.com/hkershaw-brown/CMEPS.git  
Branch: `dart-cmeps1.1.17`  
Tag: `vdart-cmeps1.1.17`

**DART_interface** (this repository)  
https://github.com/CROCODILE-CESM/DART_interface.git  
Branch: `main`  
Tag: `croc-0.0.1` 

## Creating input_nml.json for DART

This workflow generates JSON configuration files for DART from Fortran source code:

### 1. Generate the Makefile for MOM6 filter

```bash
cd $DART_interface/DART/models/MOM6/work
./quickbuild.sh filter
```

### 2. Extract default namelists from DART source

Create an `input.nml` from the DART source code contained in `Makefile.mom6.filter`:

```bash
./process_makefile_f90.sh > input.nml 2>err
```

Edit `input.nml` and set sensible values for MOM6 as needed.

### 3. Convert input.nml to YAML

```bash
python nml_to_yaml.py input.nml
```

This creates `input_nml.yaml` with values wrapped in the structure required by CESM.

### 4. Convert YAML to JSON

```bash
python yaml_to_json.py
```

This generates JSON files in the `json/` directory for use in CESM case setup.

## Testing

The repository includes a comprehensive pytest suite for the assimilation scripts:

```bash
cd tests
pytest test_assimilate.py -v
```

Tests use mocking to simulate CIME dependencies and verify correct behavior without requiring a full CESM installation.

## Known Issues

- **Calendar Requirement:** When DART is active, the model calendar must be set to GREGORIAN. Users currently need to manually run `./xmlchange CALENDAR=GREGORIAN`. Consider automating this in future versions? Let people run with a NOLEAP calendar for synthetic obs?
